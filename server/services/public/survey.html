<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опрос</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .required::after { content: " *"; color: red; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: red; margin-top: 5px; }
        .file-info { margin-top: 5px; font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <h1>Форма опроса</h1>
    <form id="surveyForm">
        <div class="form-group">
            <label for="name" class="required">Имя</label>
            <input type="text" id="name" name="name" required>
            <div class="error" id="nameError"></div>
        </div>

        <div class="form-group">
            <label for="email" class="required">Email</label>
            <input type="text" id="email" name="email" required>
            <div class="error" id="emailError"></div>
        </div>

        <div class="form-group">
            <label for="feedback" class="required">Ваш отзыв</label>
            <input type="text" id="feedback" name="feedback" required>
            <div class="error" id="feedbackError"></div>
        </div>

        <div class="form-group">
            <label for="photo">Фотография (jpg, jpeg, png)</label>
            <input type="file" id="photo" name="photo" accept=".jpg,.jpeg,.png">
            <div class="file-info" id="fileInfo">Макс. размер: 5MB</div>
            <div class="error" id="photoError"></div>
        </div>

        <button type="submit">Отправить</button>
    </form>

    <script>
        document.getElementById('photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileInfo = document.getElementById('fileInfo');
            const errorElement = document.getElementById('photoError');
            
            // Очищаем предыдущие ошибки
            errorElement.textContent = '';
            
            if (file) {
                // Проверка типа файла
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    errorElement.textContent = 'Разрешены только JPG, JPEG и PNG файлы';
                    e.target.value = ''; // Очищаем поле
                    fileInfo.textContent = 'Макс. размер: 5MB';
                    return;
                }
                
                // Проверка размера файла (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    errorElement.textContent = 'Файл слишком большой (макс. 5MB)';
                    e.target.value = '';
                    fileInfo.textContent = 'Макс. размер: 5MB';
                    return;
                }
                
                // Показываем информацию о файле
                fileInfo.textContent = `Выбран файл: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;
            } else {
                fileInfo.textContent = 'Макс. размер: 5MB';
            }
        });

        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Очистка ошибок
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value.trim());
            formData.append('email', document.getElementById('email').value.trim());
            formData.append('feedback', document.getElementById('feedback').value.trim());
            
            // Добавляем файл, если выбран
            const photoFile = document.getElementById('photo').files[0];
            if (photoFile) {
                formData.append('photo', photoFile);
            }

            // Валидация текстовых полей
            let isValid = true;
            if (!formData.get('name')) {
                document.getElementById('nameError').textContent = 'Введите имя';
                isValid = false;
            }
            if (!formData.get('email')) {
                document.getElementById('emailError').textContent = 'Введите email';
                isValid = false;
            }
            if (!formData.get('feedback')) {
                document.getElementById('feedbackError').textContent = 'Введите отзыв';
                isValid = false;
            }

            if (!isValid) return;

            try {
                const response = await fetch('/api/survey', {
                    method: 'POST',
                    body: formData // FormData автоматически устанавливает правильный Content-Type
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Данные успешно сохранены!');
                    document.getElementById('surveyForm').reset();
                    document.getElementById('fileInfo').textContent = 'Макс. размер: 5MB';
                    document.getElementById('surveyForm').reset();
                    window.location.href = '/tables.html'; 
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка соединения с сервером');
            }
        });
    </script>
</body>
</html>